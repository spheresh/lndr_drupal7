<?php
/**
 * @file
 * Code for the Lndr module
 */

define('LNDR_BASE', 'http://alpha.makehero.co/');
define('LNDR_BASE_PUBLISHED', 'http://published.makehero.co/');
define('LNDR_API_GET_PROJECT', 'http://alpha.makehero.co/v1/projects');
define('LNDR_API_VALIDATE_TOKEN', 'http://alpha.makehero.co/v1/validate_token');

/**
 * Implements hook_menu
 */
function lndr_menu() {

  $items['admin/config/content/lndr'] = array(
    'title' => 'Lndr: Landing Page Builder',
    'description' => 'Manage configuration for lndr',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('lndr_admin_settings'),
    'access arguments' => array('administer nodes'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'lndr.admin.inc',
  );

  // Links for URL validation and API method
  $items['lndr/%'] = array(
    'title' => 'Lndr page',
    'page callback' => 'lndr_page_display',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  // Drupal API to check URL availability
  $items['service/lndr/check_url'] = array(
    'title' => 'Check URI availability',
    'page callback' => 'lndr_check_url',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  // Links for development testing
  $items['examples/lndr'] = array(
    'title' => 'Test Lndr pages',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('lndr_example'),
    'access arguments' => array('administer nodes'),
    'type' => MENU_CALLBACK,
    'file' => 'lndr.example.inc',
  );

  $items['examples/lndr/render'] = array(
    'title' => 'Test Lndr pages',
    'page callback' => 'lndr_example_render',
    'access arguments' => array('administer nodes'),
    'type' => MENU_CALLBACK,
    'file' => 'lndr.example.inc',
  );

  $items['examples/lndr/service'] = array(
    'title' => 'Test Lndr service',
    'page callback' => 'lndr_example_service',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
    'file' => 'lndr.example.inc',
  );

  return $items;
}

/**
 * Implements hook_cron
 * This allow us to refactor code later to make it able to process more items
 */
function lndr_cron() {
  // @todo: later let's use cron queue
  // @todo: is there any possibility reserved path become orphaned that needs clean up
  lndr_sync_path();
}

/**
 * Syncing the url alias from Lndr.
 */
function lndr_sync_path() {
  // Get the API token
  $api_token = variable_get('lndr_token', '');
  if ($api_token === '') {
    return;
  }

  if (variable_get('lndr_debug_mode', 0) === 1) {
    // Testing, using dummy URI as request
    global $base_url;
    $result = drupal_http_request($base_url . '/examples/lndr/service', array('headers' => array('token' => $api_token,)));
  } else {
    // Let's reach out to Lndr to get list of contents
    $options = array(
      'method' => 'GET',
      'headers' => array(
        'Authorization' => 'Token token=' . $api_token,
      ),
    );
    $result = drupal_http_request(LNDR_API_GET_PROJECT, $options);
  }

  // @todo: bad token should be a 403 with message, not 500, implement on Lndr
  if ($result->code !== '200') {
    $message = 'Drupal was unable to create the page with code: %code and error: %error';
    $variables = array(
      '%code' => $result->code,
      '%error' => $result->error,
    );
    watchdog('lndr', $message, $variables, WATCHDOG_WARNING, 'admin/config/content/lndr');
    // @todo: is there another persistent way to add a message to alert admins about this, ideally add a message like there's a security updates.
    return;
  }
  $data = json_decode($result->data, true);
  if (!$data || empty($data)) {
    return;
  }
  $data = $data['projects'];

  // Create or update alias in Drupal
  _lndr_upsert_alias($data);

  // Remove alias in Drupal (when page is deleted or published to other domains)
  _lndr_remove_alias($data);
}

/**
 * Create or update alias in Drupal for Lndr pages
 * @param $projects
 */
function _lndr_upsert_alias($projects) {
  global $base_url;
  $drupal_pages = array();
  foreach ($projects as $project) {
    if (strstr($project['publish_url'], $base_url)) {
      $drupal_pages[] = $project;
    }
  }
  // Nothing to process
  if (empty($drupal_pages)) {
    return;
  }
  // Going through all the pages that are published to this URL
  foreach ($drupal_pages as $page) {
    $path = substr($page['publish_url'], strlen($base_url));
    $path = ltrim($path, '/');

    $existing_alias_by_alias = path_load(array('alias' => $path));
    if (!empty($existing_alias_by_alias)) {
      // case 1. this alias was reserved for this page, update it
      if ($existing_alias_by_alias['source'] === 'lndr/reserved') {
        $existing_alias_by_alias['source'] = 'lndr/' . $page['id'];
        $existing_alias_by_alias['alias'] = $path;
        path_save($existing_alias_by_alias);
      }
    }
    else
    {
      // case 3. let's see if a previous alias is stored, but we updated to a new one from Lndr
      $existing_alias_by_source = path_load(array('source' => 'lndr/' . $page['id']));
      if (!empty($existing_alias_by_source)) {
        // Making sure that it is still on the same domain
        if (substr($page['publish_url'], 0, strlen($base_url)) === $base_url) {
          $_path = ltrim(substr($page['publish_url'], strlen($base_url)), '/');
          if ($_path !== $existing_alias_by_source['alias']) {
            $existing_alias_by_source['alias'] = $_path;
            path_save($existing_alias_by_source);
          }
        }
      }
      else
      {
        // case 2. No Drupal alias exist at all, change from some other URL to Drupal domain URL
        $new_path = array(
          'source' => 'lndr/' . $page['id'],
          'alias' => $path,
        );
        path_save($new_path);
      }
    }
  }
}

/**
 * Remove alias in Drupal no longer published to by Lndr
 * @param $projects
 */
function _lndr_remove_alias($projects) {

  global $base_url;

  // Re-format the projects a bit to give them keys as project id
  $_projects = array();
  foreach ($projects as $project) {
    $_projects[$project['id']] = $project;
  }

  // Get all alias lndr uses (lndr/[project_id])
  $existing_alias = _lndr_load_alias();
  if (empty($existing_alias)) {
    return;
  }

  foreach ($existing_alias as $project_id => $alias) {
    // Case 5. Remove any local path not presented in the web service
    if (!array_key_exists($project_id, $_projects)) {
      path_delete($alias['pid']);
    }
    else
    {
    // Case 4. There is a local alias, however, remotely it has been changed to something not in this Domain
      if (substr($_projects[$project_id]['publish_url'], 0, strlen($base_url)) !== $base_url) {
        path_delete($alias['pid']);
      }
    }
  }
}

/**
 * Helper function that loads all of the URL alias that has a source of lndr/%
 * @return array
 */
function _lndr_load_alias() {
  $data = array();
  $query = db_select('url_alias', 'u')
    ->fields('u', array('pid', 'source', 'alias'))
    ->condition('u.source', 'lndr/%%', 'LIKE');

  $results = $query->execute();
  foreach ($results as $result) {
    // extract the lndr project id
    $path = explode('/', $result->source);
    if (is_numeric($path[1])) {
      $data[$path[1]] = (array) $result;
    }
  }
  return $data;
}

/**
 * Check whether a path alias is available, if it is, reserve it for Lndr
 */
function lndr_check_url() {
  // Check if the request has the appropriate API token in the header
  $headers = getallheaders();

  if (!array_key_exists('Authorization', $headers)) {
    // no token exist
    $response = array(
      'error' => 1,
      'message' => t('No token in the request header'),
    );
    print json_encode($response);
    return;
  }
  $api_token = variable_get('lndr_token', '');
  if ($api_token === '') {
    // no token set in Drupal yet
    $response = array(
      'error' => 1,
      'message' => t('No API token configured in Drupal'),
    );
    print json_encode($response);
    return;
  }

  $authorization = str_replace('Token token=', '', $headers['Authorization']);
  if ($api_token !== $authorization) {
    // invalid token given
    $response = array(
      'error' => 1,
      'message' => t('Invalid token given'),
    );
    print json_encode($response);
    return;
  }
  $query = drupal_get_query_parameters();

  if (!array_key_exists('path', $query)) {
    $response = array(
      'error' => 1,
      'message' => t('Required parameter path not given'),
    );
    print json_encode($response);
    return;
  }

  // 1. Let's check to see if the path is available in the system (Assuming path validation is done on Lndr side)
  $path = rtrim($query['path'], '/');
  $existing_alias = path_load(array('alias' => $path));
  if (!empty($existing_alias)) {
    $response = array(
      'error' => 1,
      'message' => t('The URL path is not available'),
    );
    print json_encode($response);
    return;
  } else {
    // reserve the url
    $path = array(
      'source' => 'lndr/reserved',
      'alias' => $path,
    );
    path_save($path);
    $response = array(
      'error' => 0,
      'message' => t('Path is available and successfully reserved'),
    );
    print json_encode($response);
    return;
  }
}

/**
 * Internal menu path to handle lndr page stubs
 * @param $page_id
 */
function lndr_page_display($page_id) {
  // Lndr actually does a 302 redirect from this URL but drupal_Http_request handles it fine
  $internal_url = LNDR_BASE . 'projects/' . $page_id;
  _lndr_import_page($internal_url);
}

/**
 * Import a page from lndr for rendering in Drupal
 * @param $url
 */
function _lndr_import_page($url) {

  $result = drupal_http_request($url);
  // error with fetching the url
  if ($result->code != '200') {
    $message = 'Lndr was unable to fetch the url: %url with code: %code and error: %error';
    $variables = array(
      '%url' => $url,
      '%code' => $result->code,
      '%error' => $result->error,
    );
    watchdog('lndr', $message, $variables, WATCHDOG_WARNING, 'node');
    $error = t('Unable to fetch the url given, please check the logs for more details');
    return array(
      'error' => 1,
      'message' => $error,
    );
  }

  // Lndr issues a redirect from projects/project_id to actual page where resource is
  if (property_exists($result, 'redirect_code')) {
    if ($result->redirect_code === '302') {
      $url = $result->redirect_url;
    }
  }

  // Start to parse the content
  module_load_include('inc', 'lndr', 'simple_html_dom');
  $html = str_get_html($result->data);

  // prepend the url of the page to all of the images
  foreach($html->find('img') as $key => $element) {
    $src= $element->src;
    $html->find('img', $key)->src = $url . $src;
  }

  // prepend url to stylesheet, assuming we only have one stylesheet so far
  $html->find('link[rel="stylesheet"]', 0)->href = $url . $html->find('link[rel="stylesheet"]', 0)->href;

  // prepend javascripts
  foreach($html->find('script') as $key => $element) {
    $src = $element->src;
    if (isset($src)) {
      $html->find('script', $key)->src = $url . $src;
    }
  }

  // prepend all of the div blocks that have background images
  $div_classes = array(
    'large-block',
    'small-block',
    'image',
    'image-slide',
  );

  foreach($div_classes as $class) {
    foreach ($html->find('div[class="' . $class . '"]') as $key => $div) {
       $bg_image = $div->{'data-background-image'};
       if (isset($bg_image)) {
         $html->find('div[class="' . $class . '"]', $key)->{'data-background-image'} = $url . $bg_image;
       }
    }
  }
  print $html;
}
